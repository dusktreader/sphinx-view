#!/usr/bin/env python

from argparse import ArgumentParser, ArgumentDefaultsHelpFormatter
from sview.utilities.app import create_app, build
import tempfile
import os

if __name__ == '__main__':
    parser = ArgumentParser(
        formatter_class=ArgumentDefaultsHelpFormatter,
        description='Start the Flask webserver',
        )
    parser.add_argument(
        '-p',
        '--port',
        type=int,
        default=5656,
        help='Set the flask webserver port',
        )
    parser.add_argument(
        'target',
        nargs=1,
        help='The target to view',
    )
    args = parser.parse_args()

    target = args.target.pop()
    if not os.path.isfile(target):
        parser.error("The target must be a single file")

    with tempfile.TemporaryDirectory() as working_dir:
        app = create_app(
            TARGET=target,
            WORKING_DIR=working_dir,
            SERVER_PORT=args.port,
        )
        build(target, working_dir)
        app.run(host='0.0.0.0', port=args.port, debug=True, extra_files=[target])
