#!/usr/bin/env python

import os
import tempfile

from argparse import ArgumentParser, ArgumentDefaultsHelpFormatter
from sview import create_server, build

if __name__ == '__main__':
    parser = ArgumentParser(
        formatter_class=ArgumentDefaultsHelpFormatter,
        description='Start the Flask webserver',
        )
    parser.add_argument(
        '-p',
        '--port',
        type=int,
        default=5656,
        help='Set the flask webserver port',
        )
    parser.add_argument(
        'target',
        nargs=1,
        help='The target to view',
    )
    args = parser.parse_args()

    target = args.target.pop()
    if not os.path.isfile(target):
        parser.error("The target must be specified as a single file")

    with tempfile.TemporaryDirectory() as working_dir:
        build(target, working_dir)
        server = create_server(
            TARGET=target,
            WORKING_DIR=working_dir,
            SERVER_PORT=args.port,
        )
        server.serve(port=args.port, host='localhost', open_url=True)
